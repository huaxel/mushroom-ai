name: Deploy to Fly.io

on:
  push:
    paths:
      - 'api/**'
  pull_request:
    paths:
      - 'api/**'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd api
          pip install -r requirements.txt
          pip install pytest httpx

      - name: Run tests
        run: |
          cd api
          # Create empty conftest.py if needed or just rely on python -m
          # We need to make sure 'api' package is resolvable if we run from root, 
          # but here we are inside api/, so we might need to adjust imports or run from root.
          # Let's run from root for better path resolution as seen in local dev.
          cd ..
          pip install -r api/requirements.txt
          pip install pytest httpx
          # Create __init__ if missing (though checkout should have it if I committed it, 
          # but I only created it locally. I should probably ensure it's created or python -m works)
          python -m pytest api/tests/test_api.py

  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1
        with:
          version: latest

      - name: Deploy to Fly
        run: flyctl deploy --remote-only --app mushroom-ai --config api/fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
